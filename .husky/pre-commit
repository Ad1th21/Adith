#!/bin/sh
. "$(dirname "$0")/_/husky.sh"

echo "üîç Running pre-commit checks..."

# Get list of staged files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM)

if [ -z "$STAGED_FILES" ]; then
    echo "No files to validate"
    exit 0
fi

echo "Validating staged files:"
echo "$STAGED_FILES"

# Validate each file
for file in $STAGED_FILES; do
    if [ ! -f "$file" ]; then
        continue
    fi
    
    echo "Checking: $file"
    
    # Check file size (max 5MB)
    size=$(stat -f%z "$file" 2>/dev/null || stat -c%s "$file" 2>/dev/null || echo 0)
    if [ "$size" -gt 5242880 ]; then
        echo "‚ùå Error: $file is too large (${size} bytes > 5MB)"
        exit 1
    fi
    
    # Validate by extension
    case "$file" in
        *.html)
            if ! grep -q "<!DOCTYPE" "$file"; then
                echo "‚ö†Ô∏è  Warning: $file missing DOCTYPE"
            fi
            ;;
        *.js|*.ts)
            # Check for debugger statements
            if grep -q "debugger" "$file"; then
                echo "‚ùå Error: debugger statement found in $file"
                exit 1
            fi
            ;;
        *.json)
            # Validate JSON syntax
            if ! python3 -m json.tool "$file" > /dev/null 2>&1; then
                echo "‚ùå Error: Invalid JSON in $file"
                exit 1
            fi
            ;;
    esac
done

echo "‚úì Pre-commit validation passed!"
exit 0
